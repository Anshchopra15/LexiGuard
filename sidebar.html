<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>LexiGuard Sidebar</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 12px; font-size: 14px; color: #333; }
    h3 { margin-top: 0; }
    #status { font-style: italic; color: #666; }
    .clause { border-left: 4px solid; padding: 8px; margin-bottom: 8px; background-color: #f9f9f9; }
    .clause.high { border-color: #e53935; } /* Red */
    .clause.mid { border-color: #fdd835; } /* Yellow */
    .clause.low { border-color: #43a047; } /* Green */
    strong { font-size: 15px; }
    textarea { width: 95%; padding: 8px; margin-top: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 8px 12px; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; }
    #answer { margin-top: 8px; white-space: pre-wrap; background: #eee; padding: 10px; border-radius: 4px; }
</style>
</head>
<body>

<h3>LexiGuard Analysis</h3>
<div id="status">Waiting for page text...</div>
<hr>

<div id="summary"></div>
<div id="clauseList"></div>

<hr>
<h3>Ask a Question</h3>
<textarea id="question" rows="3" placeholder="e.g., What is the governing law?"></textarea>
<button id="ask">Ask</button>
<div id="answer" style="margin-top:8px"></div>

<script>
let lastText = '';

// 2. Tell the content script that the sidebar is ready
window.parent.postMessage({ type: 'SIDEBAR_READY' }, '*');

// Listen for messages (e.g., from the content script)
window.addEventListener('message', async (ev) => {
    // A basic security check is good practice
    if (ev.source !== window.parent) {
        return;
    }

    const msg = ev.data || {};
    if (msg.type === 'PAGE_TEXT') {
        lastText = msg.text || '';
        document.getElementById('status').innerText = 'Analyzing...';
        analyze(lastText);
    }
});

async function analyze(text) {
    try {
        const resp = await fetch('http://localhost:8080/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text.slice(0, 40000) }) // Ensure text is not too large
        });
        if (!resp.ok) {
            throw new Error(`Server responded with status: ${resp.status}`);
        }
        const j = await resp.json();

        document.getElementById('status').innerText = 'Analysis complete.';
        document.getElementById('summary').innerHTML = '<h3>Summary</h3><p>' + escapeHtml(j.summary || 'No summary provided.') + '</p>';
        
        const list = document.getElementById('clauseList');
        list.innerHTML = '<h3>Key Clauses</h3>'; // Add a heading for the list
        
        if (j.clauses && j.clauses.length > 0) {
            (j.clauses).forEach(c => {
                const d = document.createElement('div');
                // Use c.risk for level to match the server's potential output
                d.className = 'clause ' + (c.risk === 'high' ? 'high' : c.risk === 'mid' ? 'mid' : 'low');
                d.innerHTML = '<strong>' + escapeHtml(c.title) + '</strong><div>' + escapeHtml(c.excerpt) + '</div><div><em>Risk: ' + escapeHtml(c.risk) + '</em></div>';
                list.appendChild(d);
            });
        } else {
            list.innerHTML += '<p>No specific clauses were extracted.</p>';
        }

    } catch (e) {
        console.error("Analysis error:", e);
        document.getElementById('status').innerText = 'Analysis error â€” is the local server running?';
    }
}

document.getElementById('ask').addEventListener('click', async () => {
    const q = document.getElementById('question').value.trim();
    if (!q) return;

    document.getElementById('answer').innerText = 'Thinking...';
    try {
        const resp = await fetch('http://localhost:8080/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: lastText, question: q })
        });
        if (!resp.ok) {
            throw new Error(`Server responded with status: ${resp.status}`);
        }
        const j = await resp.json();
        document.getElementById('answer').innerText = j.answer || 'No answer found.';
    } catch (e) {
        console.error("Ask error:", e);
        document.getElementById('answer').innerText = 'Server error.';
    }
});

function escapeHtml(s) {
    return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}
</script>
</body>
</html>